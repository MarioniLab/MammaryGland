--- 
title: "Interactive Markdown to explore Clustering"
author: "Karsten Bach"
date: '`r Sys.Date()`'
runtime: shiny
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    theme: united
    highlight: tango
---
***

```{r echo=FALSE, message=FALSE}
library(scran)
library(dplyr)
library(gtools)
library(knitr)
library(ggplot2)
library(reshape2)
library(pheatmap)
source("functions.R")

clustDat <- readRDS("../data/Robjects/secondRun_2500/ClusterComparison.rds") 
# bootDat <- readRDS("../data/Robjects/ClusterBootstrap.rds")
dataList <- readRDS("../data/Robjects/secondRun_2500/ExpressionList_QC_norm.rds")
set.seed(300)
dataList <- subSample(dataList,cell.number=1000)

#Commence
m <- dataList[["counts"]]
pD <- dataList[["phenoData"]]
fD <- dataList[["featureData"]]
rm(dataList)

#Gene and Cell filtering
m <- m[fD$keep,pD$PassAll]
pD <- pD[pD$PassAll,]
fD <- fD[fD$keep,]
#Normalization
m <- t(t(m)/pD$sf)

clustStats <- unlist(clustDat, recursive=FALSE)
clustStats <- clustStats[grepl("Statistics",names(clustStats))]
clustStats <- do.call(rbind,clustStats)

clustStats <- filter(clustStats, Statistic=="Average Silhouette Width")
compPlot <- ggplot(clustStats, aes(x=as.character(DeepSplit), y=Value, color=Linkage, group=Linkage)) +
    geom_path() +
    geom_point(aes(size=K)) +
    facet_grid(.~Dissimilarity, scales="free_y") +
    ylab("Average Silhouette Width") 

compPlot

inputPanel(
	   selectInput("dm", label = "Dissimilarity",
		       choices= c("euclidean","pearson","spearman"), selected="euclidean"),

	   selectInput("ds", label = "DeepSplit",
		       choices= c(0,1,2,3,4), selected=0),

	   selectInput("lk", label = "Linkage",
		       choices=c("average"), selected="average")
	  )

#Visualize Dendrograms
clustering <- reactive({
    lbl <- paste(input$dm,input$lk,input$ds,sep="_")
    cluss <- clustDat[[lbl]][["Labels"]]
})


renderTable({
    clust <- clustering()
    x <- table(clust,pD$Condition)
    out <- data.frame("Cluster"=rownames(x),
	       "Virgin"=unname(x[,"NP"]),
	       "Pregnant"=unname(x[,"G"]),
	       "Lactation"=unname(x[,"L"]),
	       "Involution"=unname(x[,"PI"]))
})

renderPlot({
    clust <- clustering()
    nclust <- length(unique(clust))
    pD$cluster <- factor(clust)
    tsnPlot <- ggplot(pD, aes(x=tSNE1, y=tSNE2, color=cluster, shape=Replicate)) +
	geom_point(size=4) +
	scale_color_discrete(rainbow(nclust))+
	theme_bw()
    tsnPlot
}, width=800, height=800)

# renderPlot({
    #     clust <- clustering()
    #     nclust <- length(unique(clust))
    #     palette(rainbow(nclust))
    #     slct <- paste(input$dm,input$lk,input$ds,sep="_")
    #     boot <- bootDat[[slct]]$bootresult
    #     boxplot(t(boot),ylim=c(0,1),col=c(1:nclust))
    # 
# }, width=800, height=800)

# renderPlot({
#     library(cluster)
#     clust <- clustering()
#     nclust <- length(unique(clust$cluster))
#     palette(rainbow(nclust))
#     sils  <- silhouette(x=clust$cluster,dist=clust$dis)
#     plot(sils,col=c(1:length(unique(clust$cluster))), border=NA)
# 
# }, width=1000, height=1800)


# renderPlot({
#     clust <- clustering()
#     pD$cluster <- clust
#     nclust <- length(unique(clust))
#     ord <- arrange(pD, cluster) 
#     simMat <- asSim(clust$dis)
#     simMat.ord <- as.matrix(simMat)[as.character(ord$barcode),
#                                     as.character(ord$barcode)]
#     library(pheatmap)
#     annoCol <- data.frame("cluster"=as.factor(ord$cluster),
#                           "Condition"=ord$Condition)
#     rownames(annoCol) <- as.character(ord$barcode)
#     ann_colors <- list("cluster"=rainbow(nclust))
#     names(ann_colors$cluster) <- c(min(ord$cluster):max(ord$cluster))
#     pheatmap(simMat.ord,
#              cluster_rows=FALSE,
#              cluster_cols=FALSE,
#              show_rownames=FALSE,
#              show_colnames=FALSE,
#              annotation_col=annoCol,
#              annotation_colors=ann_colors)
# }, width=1200, height=1200)

renderPlot({
    pD$cluster <- clustering()
    genes <- c("Acta2","Csn3","Epcam","Krt8")
	 plotGeneDist(m, pD, fD, genes, colorBy="cluster")
   }, width=1000, height=1000)


inputPanel(
	   selectInput("gene", label = "GeneOfInterest",
		       choices= mixedsort(fD$symbol), selected=c("Krt18","Acta2","Csn2","Cd74")
,
		       multiple=TRUE, selectize=FALSE)
	  )

renderPlot({
    pD$cluster <- clustering()

    genes <- input$gene
	 plotGeneDist(m, pD, fD, genes, colorBy="cluster")
   }, width=800, height=800)

```
